<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Fullstack Chat App: Code Foo 9 Application</title>
  <link rel="stylesheet" href="/assets/styles.css">
  <!-- Sniglet Font Family CDN -->
  <link href="https://fonts.googleapis.com/css?family=Sniglet" rel="stylesheet">
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
    integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
</head>

<body>
  <!-- User "Authentication" -->
  <!-- NOTE: Not actual authentication -->
  <!-- Users can use any name to join the chat -->
  <div id="auth">
    <div id="darkness">
      <div id="authContainer">
        <form id="newUser" action="" autocomplete="off">
          <label id="label1">Join the chat!</label>
          <label id="label2">Enter a username others may identify you by.</label>
          <input id="username" type="text" placeholder="Username" />
          <button id="joinChat"><i class="fas fa-arrow-circle-right"></i></button>
        </form>
      </div>
    </div>
  </div>
  <!-- Alert at top when there is a new message
      and the client isn't reading recent messages
  -->
  <div id="alertMessage"></div>
  <div class="container">
    <ul id="chat">
      <li>This is the beginning of the chat.</li>

      <!-- User is Typing Small-Text -->

      <!-- End element used for Quick Scrolling to bottom of chat -->
      <br id="end" />
      <span id="userTyping"></span>
      <div id="scrollHere" style="margin-top:100px;visibility:hidden">Test</div>
    </ul>
  </div>
  <!-- Scroll to Bottom Button -->
  <form id="chatbar" action="" autocomplete="off">
    <label id="logo">Ch@pp!</label>
    <!-- Light/Dark Mode? -->
    <!-- <form id="theme">
      <input type="radio">Dark</input>
      <input type="radio">Light</input>
    </form> -->

    <input type="checkbox" id="subscribe"/>
    <label for="subscribe">Subscribe to Chat</label>
    <!-- User Input for Chat -->
    <input type="text" id="message" placeholder="Say something!" />
    <button id="send"><i class="fas fa-arrow-circle-right"></i></button>
  </form>
  <script src="/socket.io/socket.io.js"></script>
  <script defer>
    // DOM Elements
    const message = document.getElementById('message');
    const chat = document.getElementById('chat');
    const send = document.getElementById('send');
    const auth = document.getElementById('auth');
    const username = document.getElementById('username');
    const joinChat = document.getElementById('joinChat');
    const end = document.getElementById('end');
    const userTyping = document.getElementById('userTyping');
    const scrollHere = document.getElementById('scrollHere');
    const subscribe = document.getElementById('subscribe');

    // Scroll to bottom function/button
    const scrollToBottom = () => {
      scrollHere.scrollIntoView({behavior:'smooth'});
    }

    // Subscribe to chat (scroll to bottom when there is a new message)
    subscribe.addEventListener('change',()=>{
      if(subscribe.checked)
        scrollToBottom();
    })   

    // Alert: New Message
    const alertMesage = () => {

    }

    // User "Login"
    let user; // User's name in the chat
    // SOCKET CONNECTION
    let socket = io();

    // Render all previous messages from DB
    socket.on('initial render', data => {
      // console.log(data);
      data.forEach(item => {
        // console.log(item.message);
        let message = document.createElement('li');
        message.innerHTML = `${(item.time) ? '<span class="timestamp">' + item.time + '</span>' : ''} ${(item.user === user) ? '[You]&nbsp' : ''} <span class="user">${item.user ? item.user + ":" : ''}</span>&nbsp&nbsp${item.message}`;
        // Styling if sender is not you/message is an announcement
        if (item.user !== user || !item.user)
          message.classList.add('notYou');
        chat.insertBefore(message, end);
      });
    });

    joinChat.addEventListener('click', (e) => {
      e.preventDefault();
      if (username.value != '') {
        auth.className = 'hidden';
        user = username.value;
        console.log(`Welcome to the chat, ${user}!`);

        // Announce new user
        socket.emit('new user', user);

        // Chat Functions
        const sendMessage = (e) => {
          e.preventDefault();
          if (message.value != '') {
            // Use Regex to remove (potentially harmful) html tags from user input.
            msg = message.value.replace(/(<([^>]+)>)/gm, "");
            let d = new Date();
            let timestamp = `${d.getMonth()}/${d.getDate()}/${d.getFullYear()} ${d.getHours()}:${(d.getMinutes() < 10) ? "0" + d.getMinutes() : d.getMinutes()}`;
            socket.emit('new message', { user, msg, timestamp });
            // Scroll to bottom of chat when client sends message
            scrollToBottom();
            message.value = '';
          }
          else {
            // Invalid message
            message.className = 'shake';
            message.setAttribute('disabled', true);
            setTimeout(() => {
              message.classList = '';
              message.removeAttribute('disabled');
            }, 300);
          }
        }
        // Call sendMessage on form submit
        document.getElementById('chatbar').addEventListener('submit', sendMessage);


        // BROADCASTS FROM SERVER
        // Add messages to chat
        socket.on('get message', data => {
          let message = document.createElement('li');
          message.innerHTML = `<span class="timestamp">${data.timestamp}</span> ${(data.user === user) ? '[You]&nbsp:' : ''} <span class="user">${data.user}</span>&nbsp&nbsp${data.msg}`;
          // Styling if sender is not you/message is an announcement
          if (data.user !== user || !data.user)
            message.classList.add('notYou');
          chat.insertBefore(message, end);
          if(subscribe.checked)
            scrollToBottom();
        });

        // Announce new user
        socket.on('announce user', (user) => {
          let message = document.createElement('li');
          message.appendChild(document.createTextNode(`${user} has joined the chat!`));
          message.classList.add('userJoin');
          chat.insertBefore(message, end);
          if(subscribe.checked)
            scrollToBottom();
        });

        // User Disconnected
        socket.on('user disconnected', name => {
          let message = document.createElement('li');
          message.appendChild(document.createTextNode(`${name} has left the chat.`));
          message.classList.add('userDisconnect');
          chat.insertBefore(message, end);
          if(subscribe.checked)
            scrollToBottom();
        });

        // Call button press when ENTER is pressed
        message.addEventListener('keydown', (e) => {
          if (e.keyCode === 13 && message.value != '') {
            send.classList.add('pressed');
            setTimeout(() => {
              send.classList.remove('pressed');
              socket.emit('user stopped typing',user);
            }
            , 100);
          }
        });
        // User Is Typing
        message.addEventListener('keyup', () => {
          socket.emit('user is typing', user);
        });

        // Display User is Typing
        socket.on('user is typing', users => {
          if (users[0] !== undefined && users[0] !== user)
            userTyping.innerHTML = ` ${(users.length > 1) ? 'Others are' : users[0] + " is"} typing...`;
          else
            userTyping.innerHTML = '';
        });
      }
    });


  </script>
</body>

</html>